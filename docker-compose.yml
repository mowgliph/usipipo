services:
  # ==========================================
  # OUTLINE VPN SERVER
  # ==========================================
  outline:
    image: quay.io/outline/shadowbox:stable
    container_name: outline
    restart: unless-stopped
    network_mode: host
    volumes:
      - outline_data:/opt/outline/persisted-state
    environment:
      - SB_API_PORT=${OUTLINE_API_PORT}
      - SB_API_PREFIX=${OUTLINE_API_SECRET}
      - SB_CERTIFICATE_FILE=/opt/outline/persisted-state/shadowbox-selfsigned.crt
      - SB_PRIVATE_KEY_FILE=/opt/outline/persisted-state/shadowbox-selfsigned.key
      - SB_METRICS_ENABLED=false
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--spider", "https://127.0.0.1:${OUTLINE_API_PORT}/access-keys"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # WIREGUARD VPN SERVER
  # ==========================================
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: wireguard
    network_mode: host
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Mexico_City
      - SERVERURL=${SERVER_IP}
      - SERVERPORT=${WIREGUARD_PORT}
      - PEERS=clients
      - PEERDNS=${SERVER_IP}
      - INTERNAL_SUBNET=10.13.13.0
      - ALLOWEDIPS=0.0.0.0/0,::/0
    volumes:
      - wireguard_config:/config
      - /lib/modules:/lib/modules
    # SECCIÓN ELIMINADA: sysctls no se permite en modo host
    restart: unless-stopped

  # ==========================================
  # PI-HOLE (AD BLOCKER)
  # ==========================================
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    network_mode: host
    environment:
      - TZ=America/Mexico_City
      - WEBPASSWORD=${PIHOLE_WEBPASS}
      - FTLCONF_LOCAL_IPV4=${SERVER_IP}
      - PIHOLE_DNS=1.1.1.1;8.8.8.8
      - DNSMASQ_LISTENING=all
      # ESTO ES CRÍTICO: Pi-hole v6 (imagen :latest) usa FTLCONF_webserver_port, no WEB_PORT
      # Para asegurar compatibilidad con versiones v5 y v6 ponemos ambas:
      - WEB_PORT=${PIHOLE_WEB_PORT}
      - FTLCONF_webserver_port=${PIHOLE_WEB_PORT} 
    volumes:
      - pihole_data:/etc/pihole
      - pihole_dnsmasq:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN
      # Necesario para que Pi-hole pueda hacer bind en puertos bajos si se requiriera
      - NET_BIND_SERVICE 
    healthcheck:
      test: ["CMD", "dig", "+short", "@127.0.0.1", "pi.hole"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  outline_data:
    name: outline_data
  wireguard_config:
    name: wireguard_config
  pihole_data:
    name: pihole_data
  pihole_dnsmasq:
    name: pihole_dnsmasq
