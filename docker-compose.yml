services:
  # ========== OUTLINE VPN SERVER ==========
  outline:
    image: quay.io/outline/shadowbox:stable
    container_name: outline
    restart: unless-stopped
    ports:
      - "${OUTLINE_API_PORT}:${OUTLINE_API_PORT}/tcp"
    volumes:
      - outline_data:/opt/outline/persisted-state
    environment:
      - SB_API_PORT=${OUTLINE_API_PORT}
      - SB_API_PREFIX=${OUTLINE_API_SECRET}
      - SB_CERTIFICATE_FILE=/opt/outline/persisted-state/shadowbox-selfsigned.crt
      - SB_PRIVATE_KEY_FILE=/opt/outline/persisted-state/shadowbox-selfsigned.key
    networks:
      - vpn_network
    # Healthcheck para asegurar que Outline est√© listo
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:${OUTLINE_API_PORT}/access-keys"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ========== WIREGUARD VPN SERVER ==========
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Mexico_City
      - SERVERURL=${SERVER_IPV4}
      - SERVERPORT=${WIREGUARD_PORT}
      - PEERS=10
      - PEERDNS=${PIHOLE_DNS}
      - INTERNAL_SUBNET=10.13.13.0
      - ALLOWEDIPS=0.0.0.0/0,::/0
    volumes:
      - wireguard_config:/config
    ports:
      - "${WIREGUARD_PORT}:51820/udp"
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0
    restart: unless-stopped
    networks:
      - vpn_network

  # ========== PI-HOLE (AD BLOCKER) ==========
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "${PIHOLE_WEB_PORT}:80/tcp"
    environment:
      - TZ=America/Mexico_City
      - WEBPASSWORD=${PIHOLE_WEBPASS}
      - FTLCONF_LOCAL_IPV4=${SERVER_IPV4}
      - PIHOLE_DNS_=1.1.1.1;8.8.8.8
      - DNSMASQ_LISTENING=all
    volumes:
      - pihole_data:/etc/pihole
      - pihole_dnsmasq:/etc/dnsmasq.d
    networks:
      - vpn_network
    dns:
      - 127.0.0.1
      - 1.1.1.1
    cap_add:
      - NET_ADMIN
    healthcheck:
      test: ["CMD", "dig", "+short", "@127.0.0.1", "pi.hole"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  vpn_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  outline_data:
    driver: local
  wireguard_config:
    driver: local
  pihole_data:
    driver: local
  pihole_dnsmasq:
    driver: local
