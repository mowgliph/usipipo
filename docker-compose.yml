name: usipipo-vpn-manager

services:
  # ==========================================
  # üõ°Ô∏è Outline VPN (Shadowbox)
  # ==========================================
  outline:
    image: quay.io/outline/shadowbox:stable
    container_name: outline
    restart: unless-stopped
    # MODO HOST: Cr√≠tico para que Outline gestione sus puertos din√°micos correctamente
    network_mode: host
    environment:
      - SB_API_SECRET=${OUTLINE_API_SECRET}
      - SB_API_PORT=${OUTLINE_API_PORT}
      # Outline detectar√° la IP p√∫blica autom√°ticamente o la forzaremos en el config
    volumes:
      - outline_data:/opt/outline/persisted-state
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ==========================================
  # üîí WireGuard VPN
  # ==========================================
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: wireguard
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE # Requerido para m√≥dulos del kernel
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - SERVERURL=${SERVER_IP}
      - SERVERPORT=${WIREGUARD_PORT}
      - PEERS=1
      - PEERDNS=${PIHOLE_DNS} # Se inyectar√° desde el .env
      - INTERNAL_SUBNET=10.77.77.0
    volumes:
      - wireguard_config:/config
      - /lib/modules:/lib/modules
    ports:
      - "${WIREGUARD_PORT}:51820/udp"
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    networks:
      - vpn_network

  # ==========================================
  # üéØ Pi-hole (Ad Blocking & DNS)
  # ==========================================
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    environment:
      - TZ=UTC
      - WEBPASSWORD=${PIHOLE_WEBPASS}
      # DNS Upstream (Google/Cloudflare) para que Pi-hole resuelva lo que no bloquea
      - PIHOLE_DNS=8.8.8.8;1.1.1.1 
    volumes:
      - pihole_etc:/etc/pihole
      - pihole_dnsmasq:/etc/dnsmasq.d
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "${PIHOLE_WEB_PORT}:80/tcp"
    networks:
      - vpn_network
    depends_on:
      - wireguard

volumes:
  outline_data:
  wireguard_config:
  pihole_etc:
  pihole_dnsmasq:

networks:
  vpn_network:
    driver: bridge
