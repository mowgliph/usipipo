services:
  # ==========================================
  # OUTLINE VPN SERVER
  # ==========================================
  outline:
    image: quay.io/outline/shadowbox:stable
    container_name: outline
    restart: unless-stopped
    network_mode: host
    # En modo host, los volúmenes son críticos, no los puertos
    volumes:
      - outline_data:/opt/outline/persisted-state
    environment:
      - SB_API_PORT=${OUTLINE_API_PORT}
      - SB_API_PREFIX=${OUTLINE_API_SECRET}
      - SB_CERTIFICATE_FILE=/opt/outline/persisted-state/shadowbox-selfsigned.crt
      - SB_PRIVATE_KEY_FILE=/opt/outline/persisted-state/shadowbox-selfsigned.key
      - SB_METRICS_ENABLED=false
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--spider", "https://127.0.0.1:${OUTLINE_API_PORT}/access-keys"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # WIREGUARD VPN SERVER
  # ==========================================
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: wireguard
    network_mode: host
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Mexico_City
      - SERVERURL=${SERVER_IP}
      - SERVERPORT=${WIREGUARD_PORT}
      - PEERS=clients
      # IMPORTANTE: Los clientes usarán la IP del Servidor (Pi-hole) como DNS
      - PEERDNS=${SERVER_IP}
      - INTERNAL_SUBNET=10.13.13.0
      - ALLOWEDIPS=0.0.0.0/0,::/0
    volumes:
      - wireguard_config:/config
      - /lib/modules:/lib/modules
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0
    restart: unless-stopped

  # ==========================================
  # PI-HOLE (AD BLOCKER)
  # ==========================================
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    network_mode: host
    environment:
      - TZ=America/Mexico_City
      - WEBPASSWORD=${PIHOLE_WEBPASS}
      # IP pública para que el panel de admin redirija bien si es necesario
      - FTLCONF_LOCAL_IPV4=${SERVER_IP}
      # Servidores DNS Upstream (Google/Cloudflare) que Pi-hole usará para resolver lo que no bloquee
      - PIHOLE_DNS=1.1.1.1;8.8.8.8
      # Escuchar en todas las interfaces (necesario para responder a wg0 y docker0)
      - DNSMASQ_LISTENING=all
      # IMPORTANTE: Cambia el puerto interno de lighttpd para no chocar con el puerto 80 del host
      - WEB_PORT=${PIHOLE_WEB_PORT}
    volumes:
      - pihole_data:/etc/pihole
      - pihole_dnsmasq:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN
    healthcheck:
      test: ["CMD", "dig", "+short", "@127.0.0.1", "pi.hole"]
      interval: 30s
      timeout: 10s
      retries: 3

# Definición explícita de volúmenes
volumes:
  outline_data:
    name: outline_data
  wireguard_config:
    name: wireguard_config
  pihole_data:
    name: pihole_data
  pihole_dnsmasq:
    name: pihole_dnsmasq
