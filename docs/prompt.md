Refactoriza correctamente el código de este servicio, solucionando todos los errores presentes, asegurándote de que siga la arquitectura async del proyecto: usa AsyncSessionLocal para sesiones de base de datos, convierte todas las funciones a async/await donde sea aplicable, estandariza parámetros user_id a strings UUID, integra logging de errores estructurado, y armoniza con las capas CRUD, Services y Handlers según el contexto de refactorización proporcionado. Elimina importaciones directas de CRUD y delega operaciones de base de datos a través de servicios intermedios para mantener la separación de responsabilidades. Resuelve cualquier error de pylint relacionado con importaciones, variables locales excesivas o manejo de excepciones, replicando patrones consistentes de manejo de errores y feedback al usuario.



Analyze the current Lightning payments implementation in services/lightning_payments.py, the database models in database/models.py, and the CoinGate API documentation (https://developer.coingate.com/reference/api-overview and https://developer.coingate.com/reference/cryptocurrency-payment-api). Design a refactoring plan to integrate CoinGate for production use, including necessary model updates, CRUD changes, and service refactoring. Ensure idempotency by storing invoice_id and metadata. Provide a detailed specification for the changes, focusing on eliminating the old BTCPay/OpenNode implementation and integrating the required functions: create_invoice, webhook_handler, reconciliation. Maintain backward compatibility where possible and include error handling for API failures, rate limits, and invalid responses.